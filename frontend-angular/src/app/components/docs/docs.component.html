<div class="column column--docs" [class.collapsed]="collapsed">
  <div class="docs-header">
    <h2 class="panel-title">1. Job & T√†i li·ªáu</h2>
    <button
      class="toggle-docs-btn"
      (click)="onToggleCollapse()"
      [title]="collapsed ? 'M·ªü r·ªông' : 'Thu g·ªçn'"
      type="button"
      aria-label="Thu g·ªçn / M·ªü r·ªông">
      <span>{{ collapsed ? '‚ñ∂' : '‚óÄ' }}</span>
    </button>
  </div>

  <!-- Upload -->
  <section class="block upload-block">
    <h3 class="block-title">T·∫£i file l√™n (t·∫°o job OCR)</h3>
    <p class="block-desc">Ch·ªçn file PDF ho·∫∑c ·∫£nh ‚Üí Upload. Job ƒë∆∞·ª£c t·∫°o v√† ƒë∆∞a v√†o h√†ng ƒë·ª£i x·ª≠ l√Ω OCR.</p>
    <div class="upload-row">
      <label class="file-label">
        <input
          id="upload-file"
          type="file"
          accept="application/pdf,image/*"
          (change)="onFileSelected($event)" />
        <span class="file-btn">Ch·ªçn file</span>
        <span class="file-name">{{ selectedFile ? selectedFile.name : 'Kh√¥ng c√≥ t·∫≠p n√†o ƒë∆∞·ª£c ch·ªçn' }}</span>
      </label>
      <button
        class="btn btn-primary"
        (click)="uploadDocument()"
        [disabled]="!selectedFile || isUploading">
        {{ isUploading ? 'ƒêang t·∫£i l√™n...' : 'Upload' }}
      </button>
    </div>
    <div *ngIf="isUploading || uploadLog.length" class="upload-feedback">
      <div *ngIf="isUploading" class="progress-bar">
        <div class="progress-fill" [style.width.%]="uploadProgress"></div>
      </div>
      <pre class="upload-log" *ngIf="uploadLog.length">{{ uploadLog.join('\n') }}</pre>
    </div>
  </section>

  <!-- Danh s√°ch Job (ngu·ªìn s·ª± th·∫≠t) -->
  <section class="block jobs-block">
    <div class="block-head">
      <h3 class="block-title">Danh s√°ch job OCR</h3>
      <button class="btn btn-secondary" type="button" (click)="loadOcrJobs()" [disabled]="loadingJobs">
        {{ loadingJobs ? '...' : 'L√†m m·ªõi' }}
      </button>
    </div>
    <p class="block-desc">Ch·ªçn job ƒë·ªÉ xem PDF b√™n c·∫°nh. D√πng "Ch·∫°y l·∫°i" ƒë·ªÉ ƒë∆∞a job v√†o h√†ng ƒë·ª£i x·ª≠ l√Ω l·∫°i.</p>
    <div *ngIf="loadingJobs" class="state-msg">ƒêang t·∫£i...</div>
    <div class="jobs-wrap" *ngIf="!loadingJobs && ocrJobs.length">
      <table class="jobs-table">
        <thead>
          <tr>
            <th>Job</th>
            <th>File</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Ti·∫øn tr√¨nh</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let job of ocrJobs"
            [class.selected]="job.job_id === documentService.state.selectedDocId">
            <td class="cell-mono" [title]="job.job_id">{{ shortId(job.job_id) }}</td>
            <td class="cell-file truncate" [title]="job.original_filename || job.job_id">{{ job.original_filename || '‚Äî' }}</td>
            <td>
              <span
                class="badge"
                [class.badge-done]="job.status === 'DONE'"
                [class.badge-fail]="job.status === 'FAILED'"
                [class.badge-pending]="job.status === 'QUEUED' || job.status === 'RUNNING'">
                {{ statusLabel(job.status) }}
              </span>
            </td>
            <td>{{ job.progress != null ? job.progress + '%' : '‚Äî' }}</td>
            <td class="cell-actions">
              <button type="button" class="btn-sm btn-view" (click)="viewJobPdf(job, $event)" title="Xem PDF">Xem PDF</button>
              <button type="button" class="btn-sm btn-rerun" (click)="rerunJob(job, $event)" [disabled]="rerunningJobId === job.job_id" title="Ch·∫°y l·∫°i OCR">Ch·∫°y l·∫°i</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div *ngIf="!loadingJobs && !ocrJobs.length" class="state-msg">Ch∆∞a c√≥ job. Upload file ƒë·ªÉ t·∫°o job.</div>
    <div *ngIf="selectedDoc" class="selected-summary">
      <span class="label">ƒêang ch·ªçn:</span> {{ selectedDoc.name }} ¬∑ {{ selectedDoc.sizeBytes | number }} bytes
    </div>
  </section>

  <!-- 2. C·∫•u h√¨nh & Workflow OCR -->
  <section class="block config-block">
    <h3 class="block-title">2. C·∫•u h√¨nh & Workflow OCR</h3>
    <div class="config-grid">
      <div class="config-item">
        <span class="config-label">Backend API</span>
        <code class="config-value">{{ apiBaseUrl }}</code>
      </div>
      <div class="config-item">
        <span class="config-label">Tenant</span>
        <code class="config-value">{{ tenantId }}</code>
      </div>
    </div>
    <div class="workflow-desc">
      <strong>Lu·ªìng x·ª≠ l√Ω:</strong> Upload ‚Üí Job v√†o h√†ng ƒë·ª£i (Celery) ‚Üí Worker OCR x·ª≠ l√Ω ‚Üí Tr·∫°ng th√°i c·∫≠p nh·∫≠t (QUEUED ‚Üí RUNNING ‚Üí DONE / FAILED). D√πng "L√†m m·ªõi" ·ªü tr√™n ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i.
    </div>

    <!-- RAG / Pipeline b·ªï sung (thu g·ªçn) -->
    <div class="advanced-toggle">
      <button type="button" class="btn-link" (click)="pipelineAdvancedExpanded = !pipelineAdvancedExpanded">
        {{ pipelineAdvancedExpanded ? '‚ñº' : '‚ñ∂' }} C·∫•u h√¨nh RAG / Pipeline b·ªï sung
      </button>
    </div>
    <div *ngIf="pipelineAdvancedExpanded" class="advanced-panel">
      <div class="small mb-1">DocId d√πng cho pipeline: <code>{{ pipelineDocId || '‚Äî' }}</code></div>
      <label>
        LLM Provider
        <select [(ngModel)]="cfgProvider" (ngModelChange)="onProviderChange($event)">
          <option value="vllm">vllm</option>
          <option value="chatgpt">chatgpt</option>
          <option value="ollama">ollama</option>
          <option value="gemini">gemini</option>
        </select>
      </label>
      <label>Model <input [(ngModel)]="cfgModel" type="text" /></label>
      <label>Temperature <input [(ngModel)]="cfgTemp" type="number" step="0.1" /></label>
      <label>Max tokens <input [(ngModel)]="cfgMaxTokens" type="number" /></label>
      <label>Chunk size <input [(ngModel)]="cfgChunkSize" type="number" /></label>
      <label>vLLM Base URL <input [(ngModel)]="cfgVllmBaseUrl" type="text" /></label>
      <label>vLLM API Key <input [(ngModel)]="cfgVllmApiKey" type="text" /></label>
      <label *ngIf="cfgProvider === 'chatgpt'">OpenAI API Key <input [(ngModel)]="cfgOpenaiApiKey" type="password" /></label>
      <div class="section-title mt-1">C√°c b∆∞·ªõc (Steps)</div>
      <label *ngFor="let step of steps" class="step-label">
        <input type="checkbox" [(ngModel)]="step.checked" [value]="step.value" /> {{ step.value }}
      </label>
      <div class="mt-1">
        <button class="btn btn-secondary" (click)="runPipeline()" [disabled]="isRunningPipeline">Run pipeline</button>
        <span class="small" [innerHTML]="pipelineStatus"></span>
      </div>
      <pre class="pipeline-logs" *ngIf="pipelineLogs">{{ pipelineLogs }}</pre>
      <div class="mt-1 flex">
        <span>Outputs</span>
        <button class="btn btn-secondary ml-1" (click)="loadOutputs()">Reload outputs</button>
      </div>
      <ul class="outputs-list">
        <li
          *ngFor="let output of outputs"
          [class.selected]="output.name === documentService.state.selectedOutputName"
          (click)="selectOutput(output)">
          <span class="name">{{ output.name }}</span>
          <span class="output-actions">
            <button type="button" class="btn-icon" (click)="viewOutput(output); $event.stopPropagation()" title="Xem">üëÅ</button>
            <button type="button" class="btn-icon btn-danger" (click)="deleteOutput(output); $event.stopPropagation()" title="X√≥a">‚úï</button>
          </span>
        </li>
      </ul>
    </div>
  </section>
</div>
