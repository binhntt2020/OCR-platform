<div class="column column--pdf" [class.fullscreen-mode]="isFullscreen">
  <div class="pdf-header">
    <h2>2. Xem PDF</h2>
    <div class="pdf-header-actions">
      <button 
        *ngIf="showPdf && !showPlaceholder"
        (click)="showCoordinates = !showCoordinates"
        class="toggle-coords-btn"
        [class.active]="showCoordinates"
        [title]="showCoordinates ? '·∫®n th√¥ng tin t·ªça ƒë·ªô' : 'Hi·ªán th√¥ng tin t·ªça ƒë·ªô'">
        üìç {{ showCoordinates ? '·∫®n t·ªça ƒë·ªô' : 'Hi·ªán t·ªça ƒë·ªô' }}
      </button>
      <button 
        *ngIf="showPdf && !showPlaceholder"
        (click)="documentService.setShowOcrBboxOnPdf(!documentService.state.showOcrBboxOnPdf)"
        class="toggle-coords-btn"
        [class.active]="documentService.state.showOcrBboxOnPdf"
        [title]="documentService.state.showOcrBboxOnPdf ? '·∫®n √¥ bbox OCR' : 'Hi·ªán √¥ bbox OCR'">
        üìê {{ documentService.state.showOcrBboxOnPdf ? '·∫®n bbox OCR' : 'Hi·ªán bbox OCR' }}
      </button>
      <button 
        *ngIf="showPdf && !showPlaceholder"
        (click)="toggleFullscreen()"
        class="fullscreen-btn"
        [title]="isFullscreen ? 'Tho√°t fullscreen (ESC)' : 'Fullscreen'">
        {{ isFullscreen ? '‚§ì' : '‚§¢' }}
      </button>
    </div>
  </div>
  <section class="pdf-viewer-wrap" [class.fullscreen]="isFullscreen">
    <div 
      #pdfViewerPlaceholder 
      class="pdf-viewer-placeholder"
      [style.display]="showPlaceholder ? 'block' : 'none'">
      Ch·ªçn file trong Documents ƒë·ªÉ xem PDF
    </div>
    <div class="pdf-container">
      <!-- Loading indicator -->
      <div *ngIf="showPdf && isLoadingPdf" class="pdf-loading">
        ƒêang t·∫£i PDF...
      </div>
      <!-- L·ªói t·∫£i PDF (ƒë√£ ch·ªçn doc nh∆∞ng load th·∫•t b·∫°i) -->
      <div *ngIf="showPdf && !isLoadingPdf && pdfLoadError" class="pdf-load-error">
        <strong>Kh√¥ng t·∫£i ƒë∆∞·ª£c PDF</strong>
        <p>{{ pdfLoadError }}</p>
        <p class="hint">ƒê·∫£m b·∫£o API ƒëang ch·∫°y t·∫°i <code>http://localhost:8100</code> v√† endpoint <code>/api/docs/.../file</code> cho ph√©p CORS.</p>
      </div>
      
      <!-- Canvas container cho PDF.js -->
      <div 
        #pdfCanvasContainer
        class="pdf-canvas-container"
        [style.display]="showPdf && !isLoadingPdf && !pdfLoadError ? 'block' : 'none'">
      </div>
      
      <!-- Overlay cho annotations v√† markers -->
      <div 
        #pdfAnnotationsOverlay 
        class="pdf-annotations-overlay" 
        [style.display]="showPdf && !isLoadingPdf && !pdfLoadError ? 'block' : 'none'">
      </div>
      <!-- Layer ri√™ng ƒë·ªÉ capture mouse events cho hi·ªÉn th·ªã t·ªça ƒë·ªô.
           Lu√¥n b·∫≠t khi c√≥ PDF, panel s·∫Ω ch·ªâ hi·ªán khi showCoordinates = true. -->
      <div 
        *ngIf="showPdf && !showPlaceholder"
        class="pdf-coordinates-capture"
        (mousemove)="onOverlayMouseMove($event)"
        (click)="onOverlayClick($event)">
      </div>
      <!-- Handle k√©o g√≥c ƒë·ªÉ ch·ªânh v√πng (x1,y1); ƒë·∫∑t tr√™n c√πng ƒë·ªÉ nh·∫≠n chu·ªôt -->
      <div
        *ngIf="regionResizeHandle && selectedNode"
        class="pdf-region-resize-handle"
        [style.left.px]="regionResizeHandle.leftPx"
        [style.top.px]="regionResizeHandle.topPx"
        (mousedown)="onRegionResizeStart($event)"
        title="K√©o ƒë·ªÉ co l·∫°i / k√©o d√†i / r·ªông ra v√πng (x1, y1), sau ƒë√≥ b·∫•m L∆∞u l·∫°i t·ªça ƒë·ªô">
      </div>
      <div 
        #coordsPanel
        *ngIf="showPdf && !showPlaceholder && showCoordinates"
        class="pdf-coordinates-display"
        (click)="$event.stopPropagation()"
        [class.has-match]="matchedNode?.node"
        [class.coords-panel-positioned]="coordsPanelLeft != null"
        [class.coords-panel-resized]="coordsPanelWidth != null || coordsPanelHeight != null"
        [style.left.px]="coordsPanelLeft ?? null"
        [style.top.px]="coordsPanelTop ?? null"
        [style.width.px]="coordsPanelWidth ?? null"
        [style.height.px]="coordsPanelHeight ?? null">
        <div class="coordinates-header coordinates-drag-handle"
             (mousedown)="onCoordsPanelMouseDown($event)"
             title="K√©o ƒë·ªÉ ƒë·ªïi v·ªã tr√≠">
          <strong>Th√¥ng tin t·ªça ƒë·ªô</strong>
          <button class="coordinates-close" (click)="showCoordinates = false" title="ƒê√≥ng">√ó</button>
        </div>
        
        <!-- Tab navigation -->
        <div class="coordinates-tabs">
          <button 
            type="button"
            class="coordinates-tab"
            [class.active]="coordsPanelActiveTab === 'node'"
            (click)="coordsPanelActiveTab = 'node'">
            Th√¥ng tin Node
          </button>
          <button 
            type="button"
            class="coordinates-tab"
            [class.active]="coordsPanelActiveTab === 'coordinates'"
            (click)="coordsPanelActiveTab = 'coordinates'">
            T·ªça ƒë·ªô
          </button>
        </div>

        <div class="coordinates-info">
          <!-- Tab 1: Th√¥ng tin node (ch·ªânh s·ª≠a ƒë∆∞·ª£c, l∆∞u th√†nh file m·ªõi xxx_ver_x.json) -->
          <div *ngIf="coordsPanelActiveTab === 'node'" class="coordinates-tab-content">
            <ng-container *ngIf="selectedNode; else noNodeSelected">
              <div class="node-detail-section">
                <div class="node-detail-label">Node: {{ selectedNode.display_number || selectedNode.structure || selectedNode.node_id }}</div>
                <div class="node-detail-fields">
                  <div class="node-detail-field">
                    <div class="node-detail-field-header">
                      <strong>Full title</strong>
                      <button type="button" class="btn-field-zoom" (click)="openTextPopup('Full title', selectedNode.full_title || selectedNode.title, 'full_title')" title="Ph√≥ng to trong c·ª≠a s·ªï popup">
                        üîç
                      </button>
                    </div>
                    <input type="text" class="node-detail-input" [ngModel]="selectedNode.full_title || selectedNode.title" (ngModelChange)="selectedNode.full_title = $event; onNodeDetailChange()" />
                  </div>
                  <div class="node-detail-field">
                    <div class="node-detail-field-header">
                      <strong>Summary</strong>
                      <button type="button" class="btn-field-zoom" (click)="openTextPopup('Summary', selectedNode.summary || '', 'summary')" title="Ph√≥ng to trong c·ª≠a s·ªï popup">
                        üîç
                      </button>
                    </div>
                    <textarea class="node-detail-textarea" rows="3" [ngModel]="selectedNode.summary" (ngModelChange)="selectedNode.summary = $event; onNodeDetailChange()"></textarea>
                  </div>
                  <div class="node-detail-field">
                    <div class="node-detail-field-header">
                      <strong>OCR Text</strong>
                      <button type="button" class="btn-field-zoom" (click)="openTextPopup('OCR Text', selectedNode.ocr_text || '', 'ocr_text')" title="Ph√≥ng to trong c·ª≠a s·ªï popup">
                        üîç
                      </button>
                    </div>
                    <textarea class="node-detail-textarea node-detail-ocr" rows="6" [ngModel]="selectedNode.ocr_text" (ngModelChange)="selectedNode.ocr_text = $event; onNodeDetailChange()"></textarea>
                  </div>
                  <!-- VƒÉn b·∫£n li√™n quan (signals t·ª´ jsonStructure content.signals) - c√≥ n√∫t ph√≥ng to, ch·ªânh s·ª≠a JSON, l∆∞u c√πng file version m·ªõi -->
                  <div class="node-detail-field node-detail-signals">
                    <div class="node-detail-field-header">
                      <strong>VƒÉn b·∫£n li√™n quan</strong>
                      <button type="button" class="btn-field-zoom" (click)="openTextPopup('VƒÉn b·∫£n li√™n quan', getSignalsJson(), 'signals')" title="Ph√≥ng to / ch·ªânh s·ª≠a JSON, ƒë√≥ng popup ƒë·ªÉ c·∫≠p nh·∫≠t, l∆∞u file m·ªõi ƒë·ªÉ ghi ƒë√®">
                        üîç
                      </button>
                    </div>
                    <div class="signals-block">
                      <ng-container *ngIf="selectedNodeSignals?.owner?.length || selectedNodeSignals?.docno?.length || selectedNodeSignals?.time?.length; else noSignals">
                        <ng-container *ngIf="selectedNodeSignals?.owner?.length">
                          <div class="signals-label">ƒê∆°n v·ªã (ch·ªß tr√¨ / ph·ªëi h·ª£p)</div>
                          <ul class="signals-list">
                            <li *ngFor="let o of selectedNodeSignals?.owner || []">
                              <span class="signals-role">{{ o.role }}</span>: {{ o.value }}
                            </li>
                          </ul>
                        </ng-container>
                        <ng-container *ngIf="selectedNodeSignals?.docno?.length">
                          <div class="signals-label">S·ªë hi·ªáu vƒÉn b·∫£n</div>
                          <ul class="signals-list">
                            <li *ngFor="let d of selectedNodeSignals?.docno || []">
                              <span class="signals-kind">{{ d.kind }}</span> {{ d.value }}
                              <span *ngIf="d.date" class="signals-date"> ‚Äî ng√†y {{ d.date }}</span>
                              <span *ngIf="d.issued_by" class="signals-issued-by"> ‚Äî c·ªßa {{ d.issued_by }}</span>
                            </li>
                          </ul>
                        </ng-container>
                        <ng-container *ngIf="selectedNodeSignals?.time?.length">
                          <div class="signals-label">Th·ªùi gian</div>
                          <ul class="signals-list">
                            <li *ngFor="let t of selectedNodeSignals?.time || []">{{ t.value }}</li>
                          </ul>
                        </ng-container>
                      </ng-container>
                      <ng-template #noSignals>
                        <div class="signals-empty">Ch∆∞a c√≥ d·ªØ li·ªáu vƒÉn b·∫£n li√™n quan (owner/docno/time).</div>
                      </ng-template>
                    </div>
                  </div>
                </div>
                <div class="node-detail-actions">
                  <button type="button" class="btn-save-new" (click)="saveAsNewVersion()" title="Ghi l·∫°i n·ªôi dung ƒë√£ ch·ªânh s·ª≠a v√†o file m·ªõi (t√™n th√™m h·∫≠u t·ªë _ver_1, _ver_2, ...)">
                    üíæ L∆∞u th√†nh file m·ªõi (xxx_ver_x.json)
                  </button>
                  <span class="save-new-status">{{ saveNewVersionStatus }}</span>
                </div>
              </div>
            </ng-container>
            <ng-template #noNodeSelected>
              <div class="coordinates-section">
                <div class="hint-text">üí° Ch·ªçn m·ªôt node t·ª´ c√¢y m·ª•c l·ª•c ƒë·ªÉ ch·ªânh s·ª≠a th√¥ng tin</div>
              </div>
            </ng-template>
          </div>

          <!-- Tab 2: Th√¥ng tin t·ªça ƒë·ªô -->
          <div *ngIf="coordsPanelActiveTab === 'coordinates'" class="coordinates-tab-content">
            <!-- ∆Øu ti√™n hi·ªÉn th·ªã theo t·ªça ƒë·ªô x0, y0 c·ªßa node (t·ª´ JSON) khi c√≥ node ch·ªçn/kh·ªõp -->
            <div class="coordinates-section">
              <div><strong>{{ matchedNode?.node ? 'T·ªça ƒë·ªô (x0, y0) t·ª´ JSON' : 'T·ªça ƒë·ªô PDF' }}</strong></div>
              <ng-container *ngIf="matchedNode?.node; then coordsJsonBlock; else coordsPdfBlock"></ng-container>
              <ng-template #coordsJsonBlock>
                <ng-container *ngIf="matchedNode as m">
                  <div>Page: {{ m.jsonPage ?? 'N/A' }}</div>
                  <div>x0: {{ m.jsonX0 != null ? (m.jsonX0 | number:'1.2-2') : 'N/A' }}</div>
                  <div>y0: {{ m.jsonY0 != null ? (m.jsonY0 | number:'1.2-2') : 'N/A' }}</div>
                  <div class="coordinates-node-title">{{ m.node?.title || m.node?.full_title || '' }}</div>
                </ng-container>
              </ng-template>
              <ng-template #coordsPdfBlock>
                <div>Page: {{ pdfCoordinates.page ?? 'N/A' }}</div>
                <div>x: {{ pdfCoordinates.x != null ? (pdfCoordinates.x | number:'1.2-2') : 'N/A' }}</div>
                <div>y: {{ pdfCoordinates.y != null ? (pdfCoordinates.y | number:'1.2-2') : 'N/A' }}</div>
              </ng-template>
            </div>
            <!-- V√πng (x0,y0,x1,y1) v√† n√∫t L∆∞u l·∫°i t·ªça ƒë·ªô khi c√≥ node ch·ªçn -->
            <div class="coordinates-section" *ngIf="currentDisplayBbox as bbox">
              <div><strong>V√πng t·ªça ƒë·ªô (x0, y0, x1, y1)</strong></div>
              <div>Page: {{ bbox.page }}</div>
              <div>x0: {{ bbox.x0 | number:'1.2-2' }} ‚Äî x1: {{ bbox.x1 | number:'1.2-2' }}</div>
              <div>y0: {{ bbox.y0 | number:'1.2-2' }} ‚Äî y1: {{ bbox.y1 | number:'1.2-2' }}</div>
              <div class="coordinates-bbox-hint">K√©o g√≥c d∆∞·ªõi-ph·∫£i v√πng tr√™n PDF ƒë·ªÉ ch·ªânh x1, y1, r·ªìi b·∫•m L∆∞u l·∫°i.</div>
              <button type="button" class="btn-save-bbox" (click)="saveBboxToJson()" title="Ghi (x0,y0,x1,y1) v√†o JSON v√† c·∫≠p nh·∫≠t m√†n h√¨nh">
                L∆∞u l·∫°i t·ªça ƒë·ªô
              </button>
            </div>
            
            <div class="coordinates-separator" *ngIf="!matchedNode?.node"></div>
            <div class="coordinates-section" *ngIf="!matchedNode?.node">
              <div class="hint-text">üí° Click v√†o PDF ho·∫∑c ch·ªçn m·ª•c trong c√¢y m·ª•c l·ª•c ƒë·ªÉ xem t·ªça ƒë·ªô (x0, y0)</div>
            </div>
            
            <!-- V·ªã tr√≠ click (khi user click tr√™n PDF, ƒë·ªÉ so s√°nh v·ªõi x0,y0) -->
            <div class="coordinates-separator" *ngIf="matchedNode?.node"></div>
            <div class="coordinates-section" *ngIf="matchedNode?.node">
              <div><strong>V·ªã tr√≠ click tr√™n PDF:</strong></div>
              <div>Page: {{ pdfCoordinates.page ?? 'N/A' }}</div>
              <div>x: {{ pdfCoordinates.x != null ? (pdfCoordinates.x | number:'1.2-2') : 'N/A' }}</div>
              <div>y: {{ pdfCoordinates.y != null ? (pdfCoordinates.y | number:'1.2-2') : 'N/A' }}</div>
            </div>
            
            <div class="coordinates-separator" *ngIf="matchedNode?.node"></div>
            
            <div class="coordinates-section" *ngIf="matchedNode as m">
              <div><strong>ƒê√°nh gi√°:</strong></div>
              <div class="accuracy-badge" [class.accuracy-exact]="m.accuracy === 'exact'"
                   [class.accuracy-close]="m.accuracy === 'close'"
                   [class.accuracy-far]="m.accuracy === 'far'"
                   [class.accuracy-not-found]="m.accuracy === 'not_found'">
                <span *ngIf="m.accuracy === 'exact'">‚úì ƒê√∫ng</span>
                <span *ngIf="m.accuracy === 'close'">~ G·∫ßn ƒë√∫ng</span>
                <span *ngIf="m.accuracy === 'far'">‚úó Sai (l·ªách xa)</span>
                <span *ngIf="m.accuracy === 'not_found'">? Kh√¥ng t√¨m th·∫•y</span>
              </div>
              <div *ngIf="m.distance !== undefined" class="distance-info">
                Kho·∫£ng c√°ch: {{ m.distance.toFixed(2) }} points
              </div>
              <div *ngIf="m.distance !== undefined && pdfCoordinates.x && m.jsonX0" class="offset-info">
                L·ªách X: {{ (pdfCoordinates.x - m.jsonX0).toFixed(2) }} points
              </div>
              <div *ngIf="m.distance !== undefined && pdfCoordinates.y && m.jsonY0" class="offset-info">
                L·ªách Y: {{ (pdfCoordinates.y - m.jsonY0).toFixed(2) }} points
              </div>
            </div>
            
            <div class="coordinates-section" *ngIf="!matchedNode?.node">
              <div class="no-match">Kh√¥ng t√¨m th·∫•y node n√†o tr√™n trang {{ pdfCoordinates.page }}</div>
            </div>
          </div>
        </div>
        <div class="coordinates-resize-handle"
             (mousedown)="onCoordsPanelResizeMouseDown($event)"
             title="K√©o ƒë·ªÉ to/nh·ªè panel">
          ‚ã∞
        </div>
      </div>

      <!-- Popup ph√≥ng to n·ªôi dung (Full title / Text / Summary / OCR Text) - k√©o th·∫£ header, co gi√£n g√≥c d∆∞·ªõi-ph·∫£i -->
      <div *ngIf="textPopup" class="text-popup-backdrop" (click)="closeTextPopup()">
        <div class="text-popup-box"
             [style.left.px]="textPopupPosition?.left"
             [style.top.px]="textPopupPosition?.top"
             [style.width.px]="textPopupSize?.width"
             [style.height.px]="textPopupSize?.height"
             (click)="$event.stopPropagation()">
          <div class="text-popup-header text-popup-drag-handle" (mousedown)="onTextPopupDragStart($event)">
            <strong>{{ textPopup.title }}</strong>
            <button type="button" class="text-popup-close" (click)="closeTextPopup()" title="ƒê√≥ng">√ó</button>
          </div>
          <textarea class="text-popup-content text-popup-edit" [(ngModel)]="textPopupEditContent" [placeholder]="textPopup.field === 'signals' ? 'Ch·ªânh s·ª≠a JSON (owner, docno, time), ƒë√≥ng popup ƒë·ªÉ c·∫≠p nh·∫≠t. L∆∞u file m·ªõi (xxx_ver_x.json) ƒë·ªÉ ghi ra ƒëƒ©a.' : 'Ch·ªânh s·ª≠a n·ªôi dung, ƒë√≥ng popup ƒë·ªÉ c·∫≠p nh·∫≠t v√†o th√¥ng tin t·ªça ƒë·ªô'"></textarea>
          <div class="text-popup-resize-handle" (mousedown)="onTextPopupResizeStart($event)" title="K√©o ƒë·ªÉ thay ƒë·ªïi k√≠ch th∆∞·ªõc">‚ã∞</div>
        </div>
      </div>
    </div>
  </section>
</div>
