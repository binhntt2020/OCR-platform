<div class="column column--pdf" [class.fullscreen-mode]="isFullscreen">
  <div class="pdf-header">
    <h2>2. Xem PDF</h2>
    <div class="pdf-header-actions">
      <button 
        *ngIf="showPdf && !showPlaceholder"
        (click)="showCoordinates = !showCoordinates"
        class="toggle-coords-btn"
        [class.active]="showCoordinates"
        [title]="showCoordinates ? 'áº¨n thÃ´ng tin tá»a Ä‘á»™' : 'Hiá»‡n thÃ´ng tin tá»a Ä‘á»™'">
        ğŸ“ {{ showCoordinates ? 'áº¨n tá»a Ä‘á»™' : 'Hiá»‡n tá»a Ä‘á»™' }}
      </button>
      <button 
        *ngIf="showPdf && !showPlaceholder"
        (click)="documentService.setShowOcrBboxOnPdf(!documentService.state.showOcrBboxOnPdf)"
        class="toggle-coords-btn"
        [class.active]="documentService.state.showOcrBboxOnPdf"
        [title]="documentService.state.showOcrBboxOnPdf ? 'áº¨n Ã´ bbox OCR' : 'Hiá»‡n Ã´ bbox OCR'">
        ğŸ“ {{ documentService.state.showOcrBboxOnPdf ? 'áº¨n bbox OCR' : 'Hiá»‡n bbox OCR' }}
      </button>
      <button 
        *ngIf="showPdf && !showPlaceholder"
        (click)="documentService.setShowDetectBboxOnPdf(!documentService.state.showDetectBboxOnPdf)"
        class="toggle-coords-btn"
        [class.active]="documentService.state.showDetectBboxOnPdf"
        [title]="documentService.state.showDetectBboxOnPdf ? 'áº¨n vÃ¹ng Detect (CRAFT)' : 'Hiá»‡n vÃ¹ng Detect (CRAFT)'">
        ğŸ”² {{ documentService.state.showDetectBboxOnPdf ? 'áº¨n vÃ¹ng Detect' : 'Hiá»‡n vÃ¹ng Detect' }}
      </button>
      <button 
        *ngIf="showPdf && !showPlaceholder && editableDetectResult && documentService.state.showDetectBboxOnPdf"
        (click)="saveDetectToServer()"
        [disabled]="savingDetect"
        class="toggle-coords-btn btn-save-detect"
        title="LÆ°u thay Ä‘á»•i vÃ¹ng Detect (kÃ©o/xÃ³a) lÃªn server">
        {{ savingDetect ? 'Äang lÆ°u...' : 'ğŸ’¾ LÆ°u vÃ¹ng Detect' }}
      </button>
      <span *ngIf="saveDetectMessage" class="save-detect-msg">{{ saveDetectMessage }}</span>
      <button 
        *ngIf="showPdf && !showPlaceholder"
        (click)="toggleFullscreen()"
        class="fullscreen-btn"
        [title]="isFullscreen ? 'ThoÃ¡t fullscreen (ESC)' : 'Fullscreen'">
        {{ isFullscreen ? 'â¤“' : 'â¤¢' }}
      </button>
    </div>
  </div>
  <section class="pdf-viewer-wrap" [class.fullscreen]="isFullscreen">
    <div 
      #pdfViewerPlaceholder 
      class="pdf-viewer-placeholder"
      [style.display]="showPlaceholder ? 'block' : 'none'">
      Chá»n file trong Documents Ä‘á»ƒ xem PDF
    </div>
    <div class="pdf-container">
      <!-- Loading indicator -->
      <div *ngIf="showPdf && isLoadingPdf" class="pdf-loading">
        Äang táº£i PDF...
      </div>
      <!-- Lá»—i táº£i PDF (Ä‘Ã£ chá»n doc nhÆ°ng load tháº¥t báº¡i) -->
      <div *ngIf="showPdf && !isLoadingPdf && pdfLoadError" class="pdf-load-error">
        <strong>KhÃ´ng táº£i Ä‘Æ°á»£c PDF</strong>
        <p>{{ pdfLoadError }}</p>
        <p class="hint">Äáº£m báº£o API Ä‘ang cháº¡y táº¡i <code>http://localhost:8100</code> vÃ  endpoint <code>/api/docs/.../file</code> cho phÃ©p CORS.</p>
      </div>
      
      <!-- Canvas container cho PDF.js -->
      <div 
        #pdfCanvasContainer
        class="pdf-canvas-container"
        [style.display]="showPdf && !isLoadingPdf && !pdfLoadError ? 'block' : 'none'">
      </div>
      
      <!-- Overlay cho annotations vÃ  markers + vÃ¹ng Detect (chá»‰nh sá»­a). Khi Ä‘ang chá»‰nh Detect báº­t pointer-events Ä‘á»ƒ kÃ©o/xÃ³a/co giÃ£n. -->
      <div 
        #pdfAnnotationsOverlay 
        class="pdf-annotations-overlay" 
        [class.editable-detect-active]="showDetectBbox && editableDetectResult"
        [style.display]="showPdf && !isLoadingPdf && !pdfLoadError ? 'block' : 'none'">
      </div>
      <!-- Layer riÃªng Ä‘á»ƒ capture mouse events cho hiá»ƒn thá»‹ tá»a Ä‘á»™.
           LuÃ´n báº­t khi cÃ³ PDF, panel sáº½ chá»‰ hiá»‡n khi showCoordinates = true. -->
      <div 
        *ngIf="showPdf && !showPlaceholder"
        class="pdf-coordinates-capture"
        (mousemove)="onOverlayMouseMove($event)"
        (click)="onOverlayClick($event)">
      </div>
      <div 
        #coordsPanel
        *ngIf="showPdf && !showPlaceholder && showCoordinates"
        class="pdf-coordinates-display"
        (click)="$event.stopPropagation()"
        [class.coords-panel-positioned]="coordsPanelLeft != null"
        [class.coords-panel-resized]="coordsPanelWidth != null || coordsPanelHeight != null"
        [style.left.px]="coordsPanelLeft ?? null"
        [style.top.px]="coordsPanelTop ?? null"
        [style.width.px]="coordsPanelWidth ?? null"
        [style.height.px]="coordsPanelHeight ?? null">
        <div class="coordinates-header coordinates-drag-handle"
             (mousedown)="onCoordsPanelMouseDown($event)"
             title="KÃ©o Ä‘á»ƒ Ä‘á»•i vá»‹ trÃ­">
          <strong>Tá»a Ä‘á»™ PDF</strong>
          <button class="coordinates-close" (click)="showCoordinates = false" title="ÄÃ³ng">Ã—</button>
        </div>
        <div class="coordinates-info">
          <div class="coordinates-section">
            <div>Page: {{ pdfCoordinates.page ?? 'â€”' }}</div>
            <div>x: {{ pdfCoordinates.x != null ? (pdfCoordinates.x | number:'1.2-2') : 'â€”' }}</div>
            <div>y: {{ pdfCoordinates.y != null ? (pdfCoordinates.y | number:'1.2-2') : 'â€”' }}</div>
            <div class="hint-text">Di chuyá»ƒn chuá»™t hoáº·c click trÃªn PDF Ä‘á»ƒ xem tá»a Ä‘á»™.</div>
          </div>
        </div>
        <div class="coordinates-resize-handle"
             (mousedown)="onCoordsPanelResizeMouseDown($event)"
             title="KÃ©o Ä‘á»ƒ to/nhá» panel">
          â‹°
        </div>
      </div>
    </div>
  </section>
</div>
